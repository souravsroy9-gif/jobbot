<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobBot Pro - Live Agartala Jobs</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Poppins', sans-serif; }
        body { background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #0f0f23 100%); min-height: 100vh; }
        .glass { background: rgba(255,255,255,0.05); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .glow-pulse { animation: glowPulse 2s infinite; }
        @keyframes glowPulse { 0%,100%{box-shadow:0 0 20px rgba(16,185,129,0.3)}50%{box-shadow:0 0 40px rgba(16,185,129,0.5)}}
        .gradient-text { background: linear-gradient(90deg,#10b981,#06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .scroll-hidden::-webkit-scrollbar { display:none; }
        .tab-btn.active { background:linear-gradient(135deg,rgba(16,185,129,0.2),rgba(6,182,212,0.2)); border-color:rgba(16,185,129,0.5); color:#10b981; }
        .job-card { transition:all 0.3s ease; }
        .job-card:hover { transform:translateY(-4px); box-shadow:0 20px 40px rgba(16,185,129,0.15); }
        .job-card.new-job { animation:newJobAnim 0.5s ease; border-color:rgba(16,185,129,0.5)!important; }
        @keyframes newJobAnim { from{transform:scale(0.95);opacity:0}to{transform:scale(1);opacity:1}}
        .btn-primary { background:linear-gradient(135deg,#10b981,#059669); transition:all 0.2s; }
        .btn-primary:hover { background:linear-gradient(135deg,#059669,#047857); }
        .btn-telegram { background:linear-gradient(135deg,#0088cc,#0077b5); }
        .btn-refresh { background:linear-gradient(135deg,#6366f1,#8b5cf6); }
        .btn-adzuna { background:linear-gradient(135deg,#f59e0b,#d97706); }
        input:focus, select:focus { outline:none; border-color:#10b981; box-shadow:0 0 0 3px rgba(16,185,129,0.2); }
        .slide-in { animation:slideIn 0.3s ease-out; }
        @keyframes slideIn { from{transform:translateX(100%)}to{transform:translateX(0)}}
        .loader { width:40px;height:40px;border:3px solid rgba(255,255,255,0.1);border-top-color:#10b981;border-radius:50%;animation:spin 1s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)}}
        .fade-in { animation:fadeIn 0.4s ease both; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
        .notification-badge { animation:bpulse 1s infinite; }
        @keyframes bpulse { 0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
        .refresh-spin { animation:spin 1s linear infinite; }
        .live-dot { animation:liveDot 1.5s infinite; display:inline-block; }
        @keyframes liveDot { 0%,100%{opacity:1}50%{opacity:0.3}}
        .app-icon { background:linear-gradient(145deg,#0d1117,#161b22); border:1.5px solid rgba(16,185,129,0.5); box-shadow:0 0 20px rgba(16,185,129,0.2), inset 0 1px 0 rgba(255,255,255,0.05); position:relative; overflow:hidden; }
        .app-icon::after { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:conic-gradient(transparent 0deg, rgba(16,185,129,0.08) 60deg, transparent 120deg); animation:iconRotate 4s linear infinite; }
        @keyframes iconRotate { to { transform:rotate(360deg); } }
        .api-badge { font-size:10px; padding:2px 6px; border-radius:20px; font-weight:600; }
        .api-local { background:rgba(16,185,129,0.15); color:#10b981; border:1px solid rgba(16,185,129,0.3); }
        .api-live { background:rgba(6,182,212,0.15); color:#06b6d4; border:1px solid rgba(6,182,212,0.3); }
        .api-cached { background:rgba(245,158,11,0.15); color:#f59e0b; border:1px solid rgba(245,158,11,0.3); }
        .progress-bar { height:4px; background:rgba(255,255,255,0.1); border-radius:2px; overflow:hidden; }
        .progress-fill { height:100%; background:linear-gradient(90deg,#10b981,#06b6d4); border-radius:2px; transition:width 0.3s ease; }
        .source-indicator { display:flex; align-items:center; gap:6px; font-size:11px; }
    </style>
</head>
<body class="text-white">

<!-- Notification Banner -->
<div id="notificationBanner" class="hidden fixed top-0 left-0 right-0 z-50 bg-gradient-to-r from-emerald-600 to-cyan-600 p-3 text-center text-sm">
    <span>üîî Enable notifications for new job alerts!</span>
    <button onclick="enableNotifications()" class="ml-3 bg-white text-emerald-600 px-3 py-1 rounded-lg text-xs font-semibold">Enable</button>
    <button onclick="dismissNotificationBanner()" class="ml-2 text-white/80 hover:text-white">‚úï</button>
</div>

<!-- Header -->
<header class="sticky top-0 z-40 glass">
    <div class="max-w-5xl mx-auto px-4 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-11 h-11 rounded-2xl glow-pulse flex items-center justify-center relative overflow-hidden" style="background:linear-gradient(145deg,#0a0a0a,#111827);border:1px solid rgba(255,255,255,0.08);box-shadow:0 0 0 1px rgba(16,185,129,0.3), 0 8px 32px rgba(16,185,129,0.25), inset 0 1px 0 rgba(255,255,255,0.06);">
                    <!-- Subtle background glow -->
                    <div style="position:absolute;inset:0;background:radial-gradient(circle at 30% 30%, rgba(16,185,129,0.12), transparent 70%);"></div>
                    <svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg" style="position:relative;z-index:1;">
                        <!-- JB monogram mark - clean geometric like Spotify/JetBrains -->
                        <!-- J shape -->
                        <path d="M8 6H13V18C13 20.2 11.5 21.5 9.5 21.5C7.8 21.5 6.5 20.5 6 19" stroke="url(#g1)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <!-- B vertical bar -->
                        <path d="M15 6V22" stroke="url(#g2)" stroke-width="2.2" stroke-linecap="round" fill="none"/>
                        <!-- B top bump -->
                        <path d="M15 6H19C20.7 6 22 7.3 22 9C22 10.7 20.7 12 19 12H15" stroke="url(#g2)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <!-- B bottom bump -->
                        <path d="M15 12H19.5C21.4 12 23 13.3 23 15.2C23 17.1 21.4 18.5 19.5 18.5H15" stroke="url(#g1)" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                        <!-- Dot accent top right -->
                        <circle cx="23.5" cy="5.5" r="2" fill="#10b981"/>
                        <defs>
                            <linearGradient id="g1" x1="6" y1="6" x2="23" y2="22" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#10b981"/>
                                <stop offset="100%" stop-color="#06b6d4"/>
                            </linearGradient>
                            <linearGradient id="g2" x1="15" y1="6" x2="23" y2="22" gradientUnits="userSpaceOnUse">
                                <stop offset="0%" stop-color="#34d399"/>
                                <stop offset="100%" stop-color="#06b6d4"/>
                            </linearGradient>
                        </defs>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold gradient-text tracking-tight">JobBot<span style="font-weight:400;opacity:0.7"> Pro</span></h1>
                    <p class="text-xs text-slate-400 flex items-center gap-1">
                        <span class="w-2 h-2 bg-emerald-400 rounded-full live-dot"></span>
                        Live ‚Ä¢ Agartala Jobs
                    </p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="lastUpdate" class="text-xs text-slate-500 hidden sm:block"></span>
                <span id="newJobsBadge" class="hidden bg-red-500 text-white text-xs px-2 py-0.5 rounded-full notification-badge">0 new</span>
                <span id="jobCounter" class="text-xs bg-emerald-500/20 text-emerald-400 px-3 py-1 rounded-full border border-emerald-500/30 font-medium">Loading...</span>
                <button onclick="refreshJobs(false)" id="refreshBtn" class="p-2.5 glass rounded-xl hover:bg-white/10 transition-all" title="Refresh Jobs">
                    <svg id="refreshIcon" class="w-5 h-5 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                </button>
                <button onclick="openSettings()" class="p-2.5 glass rounded-xl hover:bg-white/10" title="Settings">‚öôÔ∏è</button>
            </div>
        </div>
    </div>
</header>

<!-- Status Bar -->
<div class="max-w-5xl mx-auto px-4 py-2">
    <div class="flex items-center justify-between text-xs text-slate-500">
        <div class="flex items-center gap-3">
            <span id="autoUpdateStatus" class="flex items-center gap-1">
                <span class="w-2 h-2 bg-emerald-400 rounded-full live-dot"></span> Auto-update: ON
            </span>
            <span id="apiSourceLabel" class="api-badge api-local">üì¶ Local</span>
        </div>
        <div class="flex items-center gap-3">
            <span id="nextUpdateTime">Next: 5:00</span>
            <button onclick="toggleAutoUpdate()" id="toggleAutoBtn" class="text-emerald-400 hover:text-emerald-300 font-medium">Pause</button>
        </div>
    </div>
    <!-- API limit warning banner -->
    <div id="apiLimitBanner" class="hidden mt-2 glass rounded-xl px-4 py-2 text-xs flex items-center gap-2 border-yellow-500/30 bg-yellow-500/5">
        <span>‚ö†Ô∏è</span>
        <span class="text-yellow-300">API limit reached or no key set. Showing <strong>local jobs only</strong>. Add your free Adzuna key in <button onclick="openSettings()" class="underline text-yellow-200">Settings</button> for live jobs.</span>
    </div>
</div>

<!-- Search -->
<div class="max-w-5xl mx-auto px-4 py-2">
    <div class="glass rounded-2xl p-4 mb-4">
        <div class="flex gap-2">
            <input id="searchInput" type="text" placeholder="Search Agartala jobs..."
                class="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-slate-500 transition-all"
                oninput="liveSearch()" onkeypress="if(event.key==='Enter') liveSearch()">
            <button onclick="liveSearch()" class="btn-primary text-white px-5 py-3 rounded-xl font-semibold">üîç</button>
            <button onclick="clearSearch()" class="glass text-slate-400 px-3 py-3 rounded-xl hover:bg-white/10 text-xs" title="Clear">‚úï</button>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex gap-2 overflow-x-auto scroll-hidden pb-3 mb-4">
        <button id="tab-all" onclick="filterCategory('all',this)" class="tab-btn active px-4 py-2 rounded-xl border border-white/10 text-sm font-medium whitespace-nowrap glass">üìã All</button>
        <button id="tab-government" onclick="filterCategory('government',this)" class="tab-btn px-4 py-2 rounded-xl border border-white/10 text-sm font-medium whitespace-nowrap glass hover:bg-white/5">üèõÔ∏è Govt</button>
        <button id="tab-bank" onclick="filterCategory('bank',this)" class="tab-btn px-4 py-2 rounded-xl border border-white/10 text-sm font-medium whitespace-nowrap glass hover:bg-white/5">üè¶ Bank</button>
        <button id="tab-private" onclick="filterCategory('private',this)" class="tab-btn px-4 py-2 rounded-xl border border-white/10 text-sm font-medium whitespace-nowrap glass hover:bg-white/5">üè¢ Private</button>
        <button id="tab-fresher" onclick="filterCategory('fresher',this)" class="tab-btn px-4 py-2 rounded-xl border border-white/10 text-sm font-medium whitespace-nowrap glass hover:bg-white/5">üéì Freshers</button>
        <button id="tab-it" onclick="filterCategory('it',this)" class="tab-btn px-4 py-2 rounded-xl border border-white/10 text-sm font-medium whitespace-nowrap glass hover:bg-white/5">üíª IT</button>
        <button id="tab-saved" onclick="filterCategory('saved',this)" class="tab-btn px-4 py-2 rounded-xl border border-white/10 text-sm font-medium whitespace-nowrap glass hover:bg-white/5">‚≠ê Saved</button>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mb-4">
        <div class="glass rounded-xl p-3 text-center"><p class="text-xl font-bold" id="statTotal">0</p><p class="text-xs text-slate-400">Total</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-xl font-bold text-emerald-400" id="statNew">0</p><p class="text-xs text-slate-400">New</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-xl font-bold text-yellow-400" id="statSaved">0</p><p class="text-xs text-slate-400">Saved</p></div>
        <div class="glass rounded-xl p-3 text-center"><p class="text-xl font-bold text-cyan-400" id="statMatch">0</p><p class="text-xs text-slate-400">Best Match</p></div>
        <div class="glass rounded-xl p-3 text-center col-span-3 sm:col-span-1"><p class="text-xl font-bold text-purple-400" id="statApplied">0</p><p class="text-xs text-slate-400">Applied</p></div>
    </div>

    <!-- Loading -->
    <div id="loadingState" class="flex flex-col items-center py-16">
        <div class="loader mb-4"></div>
        <p class="text-slate-400 text-sm" id="loadingText">Loading Agartala jobs...</p>
        <div class="progress-bar w-48 mt-3"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
    </div>

    <!-- Empty -->
    <div id="emptyState" class="hidden flex flex-col items-center py-16">
        <div class="text-5xl mb-4">üîç</div>
        <h3 class="text-lg font-semibold mb-2">No Jobs Found</h3>
        <p class="text-slate-400 text-sm mb-4">Try a different keyword or category</p>
        <button onclick="clearSearch()" class="btn-primary text-white px-6 py-2 rounded-xl">Clear Search</button>
    </div>

    <!-- Jobs List -->
    <div id="jobsList" class="hidden space-y-3"></div>

    <!-- Load More -->
    <div id="loadMoreBtn" class="hidden mt-6 text-center">
        <button onclick="loadMoreJobs()" class="btn-refresh text-white px-8 py-3 rounded-xl font-medium">Load More Jobs</button>
    </div>
</div>

<!-- Job Modal -->
<div id="jobModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70" onclick="closeJobModal()"></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-lg bg-slate-900 border-l border-white/10 overflow-y-auto slide-in">
        <div id="jobModalContent" class="p-6"></div>
    </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/70" onclick="closeSettings()"></div>
    <div class="absolute right-0 top-0 bottom-0 w-full max-w-md bg-slate-900 border-l border-white/10 overflow-y-auto slide-in">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold">‚öôÔ∏è Settings</h2>
                <button onclick="closeSettings()" class="p-2 glass rounded-lg hover:bg-white/10">‚úï</button>
            </div>

            <!-- API Source Section -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase mb-3">üåê API Source (for Live Jobs)</h3>
                <div class="glass rounded-xl p-4 space-y-4">

                    <!-- Free option notice -->
                    <div class="bg-emerald-500/10 border border-emerald-500/20 rounded-xl p-3 text-xs text-slate-300">
                        <p class="text-emerald-400 font-semibold mb-1">‚úÖ Free Option ‚Äî Adzuna API</p>
                        <p class="mb-2">250 free calls/month. Register once, works forever.</p>
                        <ol class="list-decimal list-inside space-y-1">
                            <li>Go to <span class="text-cyan-400">developer.adzuna.com</span></li>
                            <li>Sign up free ‚Üí "Create App"</li>
                            <li>Copy <strong>App ID</strong> and <strong>App Key</strong></li>
                            <li>Paste below ‚Üí Save</li>
                        </ol>
                        <a href="https://developer.adzuna.com" target="_blank" class="inline-block mt-2 btn-adzuna text-white px-3 py-1 rounded-lg font-medium">üîó Get Free Adzuna Key</a>
                    </div>

                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">Adzuna App ID</label>
                        <input id="adzunaAppId" type="text" placeholder="e.g. 12345678" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 text-sm transition-all">
                    </div>
                    <div>
                        <label class="text-xs text-slate-400 mb-1 block">Adzuna App Key</label>
                        <input id="adzunaAppKey" type="password" placeholder="Your Adzuna App Key" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 text-sm transition-all">
                    </div>
                    <button onclick="testAdzuna()" class="w-full btn-adzuna text-white py-2.5 rounded-xl font-medium text-sm">üß™ Test Adzuna Connection</button>

                    <div class="border-t border-white/10 pt-3">
                        <p class="text-xs text-slate-400 mb-2">‚Äî OR use RapidAPI JSearch (paid) ‚Äî</p>
                        <label class="text-xs text-slate-400 mb-1 block">RapidAPI Key (JSearch)</label>
                        <input id="rapidApiKey" type="password" placeholder="Your RapidAPI Key" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 text-sm transition-all">
                        <p class="text-xs text-slate-500 mt-1">Get at: rapidapi.com ‚Üí JSearch ‚Üí Subscribe</p>
                    </div>

                    <!-- Cache Control -->
                    <div class="border-t border-white/10 pt-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm">Smart Caching</p>
                                <p class="text-xs text-slate-400">Save API calls ‚Äî cache results for 30 min</p>
                            </div>
                            <button onclick="toggleCaching()" id="cachingToggle" class="w-12 h-6 bg-emerald-500 rounded-full relative transition-all">
                                <span id="cachingThumb" class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-all"></span>
                            </button>
                        </div>
                        <button onclick="clearCache()" class="mt-2 text-xs text-slate-400 hover:text-red-400 transition-colors">üóëÔ∏è Clear cached jobs</button>
                    </div>
                </div>
            </div>

            <!-- Auto-Update -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase mb-3">üîÑ Auto-Update</h3>
                <div class="glass rounded-xl p-4 space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Enable Auto-Update</span>
                        <button onclick="toggleAutoUpdateSetting()" id="autoUpdateToggle" class="w-12 h-6 bg-emerald-500 rounded-full relative transition-all">
                            <span id="autoUpdateThumb" class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full transition-all"></span>
                        </button>
                    </div>
                    <div>
                        <label class="text-sm text-slate-300 block mb-1">Update Interval</label>
                        <select id="updateInterval" class="w-full bg-slate-800 border border-white/10 rounded-xl px-3 py-2 text-white transition-all" onchange="saveUpdateInterval()">
                            <option value="5" selected>Every 5 minutes</option>
                            <option value="10">Every 10 minutes</option>
                            <option value="30">Every 30 minutes</option>
                            <option value="60">Every 1 hour</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm">Browser Notifications</span>
                        <button onclick="enableNotifications()" id="notifToggle" class="text-xs bg-slate-700 px-3 py-1 rounded-full transition-all">Enable</button>
                    </div>
                </div>
            </div>

            <!-- Profile -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase mb-3">üë§ Your Profile</h3>
                <div class="space-y-3">
                    <input id="settingsName" type="text" placeholder="Full Name" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 transition-all">
                    <input id="settingsEmail" type="email" placeholder="Email" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 transition-all">
                    <input id="settingsPhone" type="tel" placeholder="Phone (+91 XXXXX XXXXX)" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 transition-all">
                    <input id="settingsSkills" type="text" placeholder="Skills (MS Office, Tally, English...)" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 transition-all">
                </div>
            </div>

            <!-- Telegram -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase mb-3">üì± Telegram Alerts</h3>
                <div class="glass rounded-xl p-3 mb-3 text-xs text-slate-300">
                    <p class="text-cyan-400 font-medium mb-1">Setup:</p>
                    <ol class="list-decimal list-inside space-y-1">
                        <li>Telegram ‚Üí @BotFather ‚Üí /newbot ‚Üí Get Token</li>
                        <li>Telegram ‚Üí @userinfobot ‚Üí Get Chat ID</li>
                    </ol>
                </div>
                <div class="space-y-3">
                    <input id="settingsTelegramToken" type="password" placeholder="Bot Token" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 transition-all">
                    <input id="settingsTelegramChatId" type="text" placeholder="Chat ID" class="w-full bg-slate-800 border border-white/10 rounded-xl px-4 py-2.5 text-white placeholder-slate-500 transition-all">
                    <button onclick="testTelegram()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white py-2.5 rounded-xl font-medium">üì® Test Telegram</button>
                </div>
            </div>

            <button onclick="saveSettings()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold">üíæ Save All Settings</button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="glass px-5 py-3 rounded-xl shadow-xl"><p id="toastMessage" class="text-sm font-medium"></p></div>
</div>

<!-- New Job Alert -->
<div id="newJobToast" class="fixed top-20 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="bg-gradient-to-r from-emerald-600 to-cyan-600 px-5 py-3 rounded-xl shadow-xl flex items-center gap-3">
        <span class="text-2xl">üéâ</span>
        <div>
            <p class="text-sm font-semibold">New Jobs Found!</p>
            <p class="text-xs opacity-90" id="newJobToastCount">0 new jobs</p>
        </div>
        <button onclick="hideNewJobToast()" class="ml-2 text-white/80 hover:text-white">‚úï</button>
    </div>
</div>

<script>
// ============ ADZUNA KEYS (Pre-configured) ============
const ADZUNA_APP_ID = '81f82984';
const ADZUNA_APP_KEY = 'ba97a69da22bb79d699978dc9c234eb9';
const JOBS_PER_PAGE = 12;
const CACHE_KEY = 'jobbot_api_cache';
const CACHE_DURATION_MS = 30 * 60 * 1000; // 30 minutes

// ============ STATE ============
let allJobs = [];
let filteredJobs = [];
let savedJobs = JSON.parse(localStorage.getItem('jobbot_saved') || '[]');
let appliedJobs = JSON.parse(localStorage.getItem('jobbot_applied') || '[]');
let userProfile = JSON.parse(localStorage.getItem('jobbot_profile') || '{}');
let settings = JSON.parse(localStorage.getItem('jobbot_settings') || '{"autoUpdate":true,"interval":5,"caching":true}');
let currentCategory = 'all';
let currentPage = 1;
let autoUpdateTimer = null;
let countdownTimer = null;
let nextUpdateSeconds = 0;
let toastTimeout = null;
let previousJobCount = 0;

// ============ EXPANDED LOCAL JOBS DATABASE (60+ jobs) ============
const localJobs = [
    // === GOVERNMENT ===
    {id:'g1',title:'Office Assistant',company:'Tripura Secretariat',location:'Agartala, Tripura',salary:'‚Çπ21,700 ‚Äì ‚Çπ69,100',category:'government',description:'Handle administrative tasks, file management, and official correspondence at Tripura Secretariat. Government job with job security and excellent benefits.',requirements:['12th Pass','Computer','Typing 30 WPM','Bengali/Kokborok'],posted:'Today',deadline:'15 days',url:'https://tripura.gov.in',match:88,isNew:true},
    {id:'g2',title:'Clerk cum Computer Operator',company:'District Court Agartala',location:'Agartala, Tripura',salary:'‚Çπ19,900 ‚Äì ‚Çπ63,200',category:'government',description:'Manage court documents, data entry, and administrative work at District Court Agartala.',requirements:['Graduate','Computer','Typing','Communication'],posted:'2 days ago',deadline:'20 days',url:'https://districts.ecourts.gov.in/tripura',match:92,isNew:true},
    {id:'g3',title:'Data Entry Operator',company:'Tribal Welfare Dept',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ25,000',category:'government',description:'Data entry for tribal welfare schemes. Requires fast and accurate typing skills.',requirements:['12th Pass','Typing 35 WPM','Computer'],posted:'1 day ago',deadline:'10 days',url:'https://tribal.nic.in',match:85,isNew:true},
    {id:'g4',title:'Junior Assistant',company:'BSNL Agartala',location:'Agartala, Tripura',salary:'‚Çπ21,700 ‚Äì ‚Çπ69,100',category:'government',description:'Administrative work, documentation, and customer service at BSNL Agartala circle office.',requirements:['12th Pass','Computer','Local Language'],posted:'1 week ago',deadline:'30 days',url:'https://bsnl.co.in',match:82},
    {id:'g5',title:'LDC (Lower Division Clerk)',company:'Income Tax Dept',location:'Agartala, Tripura',salary:'‚Çπ19,900 ‚Äì ‚Çπ63,200',category:'government',description:'File handling and data management at Income Tax Department Agartala.',requirements:['12th Pass','Computer','Typing 35 WPM'],posted:'3 days ago',deadline:'21 days',url:'https://incometax.gov.in',match:84},
    {id:'g6',title:'Stenographer Grade III',company:'High Court of Tripura',location:'Agartala, Tripura',salary:'‚Çπ25,500 ‚Äì ‚Çπ81,100',category:'government',description:'Stenographer at High Court. Dictation at 80 WPM, transcription, and court support.',requirements:['12th Pass','Steno 80 WPM','Computer'],posted:'1 week ago',deadline:'25 days',url:'https://hctripura.gov.in',match:75},
    {id:'g7',title:'Multi Tasking Staff (MTS)',company:'CPWD Agartala',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ56,900',category:'government',description:'General office and field work at CPWD Agartala division.',requirements:['10th Pass','Physical Fitness'],posted:'5 days ago',deadline:'20 days',url:'https://cpwd.gov.in',match:70},
    {id:'g8',title:'Forest Guard',company:'Tripura Forest Dept',location:'Agartala, Tripura',salary:'‚Çπ21,700 ‚Äì ‚Çπ69,100',category:'government',description:'Patrolling and conservation work in Tripura forests.',requirements:['12th Pass','Physical Fitness','Local Language'],posted:'2 days ago',deadline:'30 days',url:'https://tripuraforest.gov.in',match:72,isNew:true},
    {id:'g9',title:'Assistant Teacher',company:'Education Dept Tripura',location:'Agartala, Tripura',salary:'‚Çπ25,300 ‚Äì ‚Çπ81,000',category:'government',description:'Teaching primary classes in government schools across Tripura.',requirements:['Graduate','B.Ed','TET Qualified'],posted:'1 week ago',deadline:'45 days',url:'https://education.tripura.gov.in',match:78},
    {id:'g10',title:'Accountant',company:'Treasury Dept Tripura',location:'Agartala, Tripura',salary:'‚Çπ29,200 ‚Äì ‚Çπ92,300',category:'government',description:'Maintain government accounts and financial records at Treasury Department.',requirements:['B.Com','Accounting','Computer'],posted:'6 days ago',deadline:'25 days',url:'#',match:80},
    {id:'g11',title:'Office Computer Assistant',company:'Agartala Municipal Council',location:'Agartala, Tripura',salary:'‚Çπ17,000 ‚Äì ‚Çπ28,000',category:'government',description:'Data entry and citizen service support at the municipal office.',requirements:['12th Pass','MS Office','Typing'],posted:'4 days ago',deadline:'18 days',url:'https://agartalacity.gov.in',match:87},
    {id:'g12',title:'Village Level Entrepreneur',company:'Tripura Rural Development',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ25,000',category:'government',description:'Digital services delivery and CSC management for rural citizens.',requirements:['12th Pass','Computer','Local Language'],posted:'3 days ago',deadline:'15 days',url:'#',match:83},
    {id:'g13',title:'Peon/Group D',company:'PWD Tripura',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ20,000',category:'government',description:'Support staff for PWD offices in Agartala. Carrying files and assisting officers.',requirements:['8th Pass','Physical Fitness'],posted:'4 days ago',deadline:'20 days',url:'#',match:60},
    {id:'g14',title:'Junior Engineer (Civil)',company:'Tripura PWD',location:'Agartala, Tripura',salary:'‚Çπ35,000 ‚Äì ‚Çπ58,000',category:'government',description:'Civil engineering work for infrastructure projects in Tripura.',requirements:['Diploma Civil Engg','AutoCAD','Survey'],posted:'5 days ago',deadline:'30 days',url:'#',match:72},
    {id:'g15',title:'ANM / Health Worker',company:'Health Dept Tripura',location:'Agartala, Tripura',salary:'‚Çπ22,000 ‚Äì ‚Çπ35,000',category:'government',description:'Community health worker for primary health centres in Tripura.',requirements:['ANM Course','Nursing','Local Language'],posted:'1 week ago',deadline:'25 days',url:'#',match:74},

    // === BANK ===
    {id:'b1',title:'Back Office Executive',company:'Tripura State Co-op Bank',location:'Agartala, Tripura',salary:'‚Çπ22,000 ‚Äì ‚Çπ35,000',category:'bank',description:'Handle daily banking operations and customer data management.',requirements:['Graduate','Computer','Communication'],posted:'3 days ago',deadline:'25 days',url:'https://tscbank.in',match:95,isNew:true},
    {id:'b2',title:'Computer Operator',company:'State Bank of India',location:'Agartala, Tripura',salary:'‚Çπ20,000 ‚Äì ‚Çπ32,000',category:'bank',description:'Banking software operation and data entry at SBI main branch Agartala.',requirements:['Graduate','Computer','Banking Awareness'],posted:'2 days ago',deadline:'14 days',url:'https://sbi.co.in/careers',match:88,isNew:true},
    {id:'b3',title:'Clerk',company:'Union Bank of India',location:'Agartala, Tripura',salary:'‚Çπ19,900 ‚Äì ‚Çπ63,200',category:'bank',description:'Customer service and documentation at Union Bank Agartala branch.',requirements:['Graduate','Computer','Reasoning'],posted:'4 days ago',deadline:'30 days',url:'https://unionbankofindia.co.in',match:86},
    {id:'b4',title:'Probationary Officer',company:'Bank of Baroda',location:'Agartala, Tripura',salary:'‚Çπ36,000 ‚Äì ‚Çπ63,840',category:'bank',description:'PO at Bank of Baroda Agartala. Banking operations and customer relations.',requirements:['Graduate','Computer','Communication'],posted:'1 week ago',deadline:'20 days',url:'https://bankofbaroda.in/careers',match:80},
    {id:'b5',title:'Office Assistant',company:'Tripura Gramin Bank',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ28,000',category:'bank',description:'Administrative support at Tripura Gramin Bank regional office.',requirements:['12th Pass','Computer','Local Language'],posted:'3 days ago',deadline:'22 days',url:'https://tripuragraminbank.org',match:89},
    {id:'b6',title:'Data Entry Operator',company:'ICICI Bank',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ26,000',category:'bank',description:'Fast and accurate data entry at ICICI Bank Agartala branch.',requirements:['Graduate','Typing 40 WPM','Computer'],posted:'1 day ago',deadline:'15 days',url:'https://icicicareers.com',match:87,isNew:true},
    {id:'b7',title:'Customer Service Rep',company:'HDFC Bank',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ28,000',category:'bank',description:'Customer interaction and account handling at HDFC Bank.',requirements:['Graduate','Communication','Computer'],posted:'5 days ago',deadline:'20 days',url:'#',match:82},
    {id:'b8',title:'Field Officer',company:'Bandhan Bank',location:'Agartala, Tripura',salary:'‚Çπ16,000 ‚Äì ‚Çπ25,000',category:'bank',description:'Customer acquisition and loan verification for Bandhan Bank.',requirements:['Graduate','Two Wheeler','Local Language'],posted:'2 days ago',deadline:'18 days',url:'#',match:76},
    {id:'b9',title:'Relationship Manager',company:'Axis Bank',location:'Agartala, Tripura',salary:'‚Çπ25,000 ‚Äì ‚Çπ40,000',category:'bank',description:'Manage banking relationships and grow deposits for Axis Bank.',requirements:['Graduate','Sales Experience','Communication'],posted:'3 days ago',deadline:'20 days',url:'#',match:78},
    {id:'b10',title:'Branch Manager',company:'Cooperative Bank',location:'Agartala, Tripura',salary:'‚Çπ40,000 ‚Äì ‚Çπ65,000',category:'bank',description:'Manage branch operations, team, and customer portfolio.',requirements:['Graduate','5 yrs Banking','Leadership'],posted:'1 week ago',deadline:'30 days',url:'#',match:70},

    // === PRIVATE ===
    {id:'p1',title:'Back Office Executive',company:'Reliance Retail',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ22,000',category:'private',description:'Back office support for inventory, documentation, and MIS reports.',requirements:['12th Pass','Computer','Communication'],posted:'2 days ago',deadline:'Apply Soon',url:'https://careers.ril.com',match:85,isNew:true},
    {id:'p2',title:'Sales Executive',company:'Maruti Suzuki Dealer',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ30,000',category:'private',description:'Car sales and customer relationship management at Maruti showroom.',requirements:['12th Pass','Communication','Driving License'],posted:'3 days ago',deadline:'Apply Soon',url:'#',match:75},
    {id:'p3',title:'Receptionist',company:'Hotel Royal Plaza',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ22,000',category:'private',description:'Front desk, guest check-in/out, and customer handling at hotel.',requirements:['12th Pass','Communication','Computer'],posted:'2 days ago',deadline:'Apply Soon',url:'#',match:78},
    {id:'p4',title:'Tally Operator',company:'Trading Company',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ22,000',category:'private',description:'Accounts and inventory management using Tally ERP 9.',requirements:['12th Pass','Tally ERP 9','Basic Accounts'],posted:'3 days ago',deadline:'Apply Soon',url:'#',match:86},
    {id:'p5',title:'Accountant',company:'CA Firm Agartala',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ30,000',category:'private',description:'Taxation, GST filing, and audit assistance at reputed CA firm.',requirements:['B.Com','Tally','GST Knowledge'],posted:'1 week ago',deadline:'Apply Soon',url:'#',match:83},
    {id:'p6',title:'Store Keeper',company:'Big Bazaar',location:'Agartala, Tripura',salary:'‚Çπ14,000 ‚Äì ‚Çπ20,000',category:'private',description:'Inventory management, stock receiving, and barcode management.',requirements:['12th Pass','Computer Basic','Inventory Mgmt'],posted:'4 days ago',deadline:'Apply Soon',url:'#',match:80},
    {id:'p7',title:'Delivery Executive',company:'Zomato / Swiggy',location:'Agartala, Tripura',salary:'‚Çπ12,000 ‚Äì ‚Çπ20,000',category:'private',description:'Food delivery with flexible timings. Earn per delivery + incentives.',requirements:['18+ Years','Two Wheeler','Smartphone'],posted:'1 day ago',deadline:'Apply Soon',url:'#',match:68,isNew:true},
    {id:'p8',title:'Office Administrator',company:'Private School',location:'Agartala, Tripura',salary:'‚Çπ16,000 ‚Äì ‚Çπ24,000',category:'private',description:'Handle admissions, fee collection, records, and communications.',requirements:['Graduate','MS Office','Communication'],posted:'5 days ago',deadline:'Apply Soon',url:'#',match:81},
    {id:'p9',title:'Medical Representative',company:'Pharma Company',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ28,000',category:'private',description:'Promote medicines to doctors and pharmacies in Agartala territory.',requirements:['B.Sc/B.Pharm','Two Wheeler','Communication'],posted:'3 days ago',deadline:'Apply Soon',url:'#',match:74},
    {id:'p10',title:'Security Guard',company:'Security Agency',location:'Agartala, Tripura',salary:'‚Çπ12,000 ‚Äì ‚Çπ16,000',category:'private',description:'Security duty at malls, offices, and residential complexes.',requirements:['10th Pass','Physical Fitness','Ex-Army Preferred'],posted:'6 days ago',deadline:'Apply Soon',url:'#',match:60},
    {id:'p11',title:'Cook / Chef',company:'Hotel & Restaurant',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ25,000',category:'private',description:'Prepare Indian and Bengali cuisine for hotel guests.',requirements:['Cooking Experience','Hygiene','Team Work'],posted:'4 days ago',deadline:'Apply Soon',url:'#',match:65},
    {id:'p12',title:'Showroom Sales Staff',company:'Electronics Showroom',location:'Agartala, Tripura',salary:'‚Çπ14,000 ‚Äì ‚Çπ20,000',category:'private',description:'Assist customers in selecting electronics and close sales.',requirements:['12th Pass','Communication','Product Knowledge'],posted:'5 days ago',deadline:'Apply Soon',url:'#',match:72},

    // === FRESHER ===
    {id:'f1',title:'Fresher ‚Äì Back Office',company:'ICICI Bank',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ25,000',category:'fresher',description:'Entry level back office opening. Full training provided. Great start to a banking career.',requirements:['Graduate','Freshers OK','Computer'],posted:'1 day ago',deadline:'7 days',url:'https://icicicareers.com',match:90,isNew:true},
    {id:'f2',title:'Trainee ‚Äì Data Entry',company:'MNC Company',location:'Agartala, Tripura',salary:'‚Çπ12,000 ‚Äì ‚Çπ18,000',category:'fresher',description:'Trainee data entry for freshers. Learn as you earn with stipend.',requirements:['12th Pass','Typing','Computer'],posted:'2 days ago',deadline:'10 days',url:'#',match:88,isNew:true},
    {id:'f3',title:'Customer Care Executive',company:'Airtel',location:'Agartala, Tripura',salary:'‚Çπ14,000 ‚Äì ‚Çπ20,000',category:'fresher',description:'Handle inbound customer queries at Airtel Agartala call centre.',requirements:['12th Pass','Communication','Bengali/Hindi'],posted:'4 days ago',deadline:'15 days',url:'https://airtel.in/careers',match:76},
    {id:'f4',title:'Office Assistant',company:'Startup Company',location:'Agartala, Tripura',salary:'‚Çπ10,000 ‚Äì ‚Çπ15,000',category:'fresher',description:'Office assistant role for freshers. Filing, printing, and coordination.',requirements:['12th Pass','Basic Computer','Eager to Learn'],posted:'3 days ago',deadline:'Apply Soon',url:'#',match:85},
    {id:'f5',title:'Telecaller',company:'BPO Company',location:'Agartala, Tripura',salary:'‚Çπ12,000 ‚Äì ‚Çπ18,000',category:'fresher',description:'Outbound telecalling for product surveys and lead generation.',requirements:['12th Pass','Clear Communication'],posted:'2 days ago',deadline:'Apply Soon',url:'#',match:78},
    {id:'f6',title:'Digital Marketing Trainee',company:'Digital Agency',location:'Agartala, Tripura',salary:'‚Çπ10,000 ‚Äì ‚Çπ15,000',category:'fresher',description:'Learn SEO, social media ads, and content marketing on the job.',requirements:['Graduate','Internet Savvy','English'],posted:'4 days ago',deadline:'Apply Soon',url:'#',match:75},
    {id:'f7',title:'Marketing Executive',company:'Insurance Company',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ25,000',category:'fresher',description:'Field marketing for insurance products. Incentive-based income.',requirements:['12th Pass','Communication','Two Wheeler'],posted:'1 week ago',deadline:'20 days',url:'#',match:72},
    {id:'f8',title:'Computer Trainee',company:'Computer Centre',location:'Agartala, Tripura',salary:'‚Çπ8,000 ‚Äì ‚Çπ12,000',category:'fresher',description:'Learn and assist in teaching MS Office and basic computing skills.',requirements:['12th Pass','Basic Computer Interest'],posted:'5 days ago',deadline:'Apply Soon',url:'#',match:80},
    {id:'f9',title:'HR Trainee',company:'Consultancy Firm',location:'Agartala, Tripura',salary:'‚Çπ10,000 ‚Äì ‚Çπ14,000',category:'fresher',description:'HR assistance for recruitment drives and employee onboarding.',requirements:['Graduate (HR/BBA)','Communication'],posted:'3 days ago',deadline:'Apply Soon',url:'#',match:77},

    // === IT ===
    {id:'i1',title:'Web Developer',company:'IT Company Agartala',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ35,000',category:'it',description:'Build and maintain websites using HTML, CSS, JavaScript. React experience a plus.',requirements:['HTML/CSS/JS','React','Portfolio'],posted:'2 days ago',deadline:'Apply Soon',url:'#',match:83,isNew:true},
    {id:'i2',title:'Computer Operator',company:'Agartala IT Solutions',location:'Agartala, Tripura',salary:'‚Çπ12,000 ‚Äì ‚Çπ20,000',category:'it',description:'Data management, documentation, and computer operations in IT firm.',requirements:['12th Pass','MS Office','Typing'],posted:'1 day ago',deadline:'Apply Soon',url:'#',match:82,isNew:true},
    {id:'i3',title:'Mobile App Developer',company:'Tech Startup',location:'Agartala, Tripura',salary:'‚Çπ25,000 ‚Äì ‚Çπ50,000',category:'it',description:'Build Android/iOS apps using Flutter or React Native.',requirements:['Flutter / React Native','GitHub','Portfolio'],posted:'3 days ago',deadline:'Apply Soon',url:'#',match:79},
    {id:'i4',title:'Software Tester (QA)',company:'Software Firm',location:'Agartala, Tripura',salary:'‚Çπ18,000 ‚Äì ‚Çπ28,000',category:'it',description:'Manual and automated testing for web and mobile applications.',requirements:['B.Sc IT / BCA','Testing Tools','Attention to Detail'],posted:'4 days ago',deadline:'Apply Soon',url:'#',match:76},
    {id:'i5',title:'Network Engineer',company:'ISP Company',location:'Agartala, Tripura',salary:'‚Çπ20,000 ‚Äì ‚Çπ32,000',category:'it',description:'Configure routers, switches, and maintain network infrastructure.',requirements:['B.Sc IT / CCNA','Networking','Troubleshooting'],posted:'5 days ago',deadline:'Apply Soon',url:'#',match:74},
    {id:'i6',title:'Graphic Designer',company:'Design Studio',location:'Agartala, Tripura',salary:'‚Çπ15,000 ‚Äì ‚Çπ28,000',category:'it',description:'Create social media graphics, brochures, and UI designs.',requirements:['Photoshop / Illustrator','Portfolio','Creativity'],posted:'2 days ago',deadline:'Apply Soon',url:'#',match:80},
    {id:'i7',title:'Content Writer',company:'Digital Agency',location:'Agartala, Tripura',salary:'‚Çπ12,000 ‚Äì ‚Çπ22,000',category:'it',description:'Write blog posts, SEO articles, and social media content.',requirements:['Graduate','Fluent English','Research Skills'],posted:'3 days ago',deadline:'Apply Soon',url:'#',match:77},
    {id:'i8',title:'Data Analyst',company:'Analytics Company',location:'Agartala (Remote possible), Tripura',salary:'‚Çπ22,000 ‚Äì ‚Çπ40,000',category:'it',description:'Analyse data using Excel, Python, or Power BI for business insights.',requirements:['Graduate','Excel/Python','Analytical Thinking'],posted:'1 week ago',deadline:'Apply Soon',url:'#',match:78},
];

// ============ INIT ============
document.addEventListener('DOMContentLoaded', () => {
    loadSettingsToForm();
    loadSavedSettings();
    showLocalJobsImmediately();
    fetchLiveJobsIfPossible();
    setupAutoUpdate();
    checkNotificationPermission();
});

function showLocalJobsImmediately() {
    allJobs = [...localJobs];
    sortJobs();
    filterCategory('all');
    showLoading(false);
    updateStats();
    // Keys are built-in, hide the warning banner always
    document.getElementById('apiLimitBanner').classList.add('hidden');
    setApiBadge('live');
}

// ============ LIVE JOB FETCHING ============
async function fetchLiveJobsIfPossible(isAutoUpdate = false) {
    // Use hardcoded keys OR user-provided keys (user keys take priority)
    const adzunaId  = userProfile.adzunaAppId  || ADZUNA_APP_ID;
    const adzunaKey = userProfile.adzunaAppKey || ADZUNA_APP_KEY;
    const hasAdzuna = adzunaId && adzunaKey;
    const hasRapidApi = userProfile.rapidApiKey;

    if (!hasAdzuna && !hasRapidApi) return;

    // Hide the "no key" warning since we have built-in keys
    document.getElementById('apiLimitBanner').classList.add('hidden');

    // Check cache first
    if (settings.caching) {
        const cached = loadFromCache();
        if (cached) {
            mergeApiJobs(cached);
            setApiBadge('cached');
            if (!isAutoUpdate) showToast('‚úÖ Loaded from cache (' + cached.length + ' live jobs)');
            return;
        }
    }

    let apiJobs = [];

    if (hasAdzuna) {
        setApiBadge('live');
        apiJobs = await fetchFromAdzuna(adzunaId, adzunaKey);
    } else if (hasRapidApi) {
        setApiBadge('live');
        apiJobs = await fetchFromRapidApi();
    }

    if (apiJobs.length > 0) {
        if (settings.caching) saveToCache(apiJobs);
        const prevCount = allJobs.length;
        mergeApiJobs(apiJobs);
        if (isAutoUpdate && allJobs.length > prevCount) {
            const diff = allJobs.length - prevCount;
            showNewJobsAlert(diff);
            sendNewJobsNotification(diff);
        } else if (!isAutoUpdate) {
            showToast(`‚úÖ ${apiJobs.length} live jobs loaded!`);
        }
    } else {
        setApiBadge('local');
    }
}

// CORS Proxies ‚Äî tries each one until one works
const CORS_PROXIES = [
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url => `https://proxy.cors.sh/${url}`,
    url => url // last resort: direct (may fail)
];

async function fetchWithCorsProxy(url) {
    for (const proxy of CORS_PROXIES) {
        try {
            const proxiedUrl = proxy(url);
            const res = await fetch(proxiedUrl, { 
                headers: { 'X-Requested-With': 'XMLHttpRequest' },
                signal: AbortSignal.timeout(8000)
            });
            if (!res.ok) continue;
            const data = await res.json();
            // Make sure it's real Adzuna data not proxy error page
            if (data.results !== undefined || data.count !== undefined) return data;
        } catch (e) { continue; }
    }
    return null;
}

async function fetchFromAdzuna(appId, appKey) {
    const queries = [
        { what: 'jobs',        where: 'Agartala' },
        { what: 'government',  where: 'Tripura'  },
        { what: 'bank clerk',  where: 'Agartala' },
        { what: 'computer operator', where: 'Tripura' },
        { what: 'data entry',  where: 'Agartala' },
        { what: 'office assistant', where: 'Tripura' },
    ];
    let jobs = [];
    setProgress(10);

    for (let i = 0; i < queries.length; i++) {
        try {
            const { what, where } = queries[i];
            const url = `https://api.adzuna.com/v1/api/jobs/in/search/1`
                + `?app_id=${appId}&app_key=${appKey}`
                + `&results_per_page=20`
                + `&what=${encodeURIComponent(what)}`
                + `&where=${encodeURIComponent(where)}`
                + `&sort_by=date`
                + `&content-type=application/json`;

            const data = await fetchWithCorsProxy(url);
            if (!data) continue;

            const mapped = (data.results || []).map(j => ({
                id: 'adzuna-' + j.id,
                title: j.title || 'Job Opening',
                company: j.company?.display_name || 'Company',
                location: j.location?.display_name || 'Agartala, Tripura',
                salary: j.salary_min
                    ? `‚Çπ${Math.round(j.salary_min).toLocaleString('en-IN')} ‚Äì ‚Çπ${Math.round(j.salary_max || j.salary_min * 1.3).toLocaleString('en-IN')}`
                    : 'As per industry',
                category: detectCategoryFromText(j.title, j.company?.display_name),
                description: (j.description || 'Apply now for this opportunity in Agartala/Tripura.').substring(0, 250),
                requirements: [],
                posted: formatDate(j.created),
                deadline: 'Apply Soon',
                url: j.redirect_url || '#',
                match: calcMatchLocal(j.title),
                isNew: isRecent(j.created),
                source: 'üåê Live'
            }));
            jobs = jobs.concat(mapped);
            setProgress(15 + ((i + 1) / queries.length) * 80);
            document.getElementById('loadingText').textContent = `Fetching live jobs... (${jobs.length} found)`;
        } catch (e) { /* skip this query */ }
    }

    setProgress(100);
    return jobs;
}

async function fetchFromRapidApi() {
    const key = userProfile.rapidApiKey;
    const queries = ['jobs Agartala Tripura', 'government jobs Tripura 2025', 'bank jobs Agartala'];
    let jobs = [];

    setProgress(10);
    for (let i = 0; i < queries.length; i++) {
        try {
            const res = await fetch(`https://jsearch.p.rapidapi.com/search?query=${encodeURIComponent(queries[i])}&num=15&page=1&country=in`, {
                headers: { 'X-RapidAPI-Key': key, 'X-RapidAPI-Host': 'jsearch.p.rapidapi.com' }
            });
            if (!res.ok) continue;
            const data = await res.json();
            if (data.message && data.message.toLowerCase().includes('limit')) {
                document.getElementById('apiLimitBanner').classList.remove('hidden');
                break;
            }
            const mapped = (data.data || []).map(j => ({
                id: 'api-' + j.job_id,
                title: j.job_title || 'Job Opening',
                company: j.employer_name || 'Company',
                location: j.job_city ? `${j.job_city}, ${j.job_state || 'Tripura'}` : 'Agartala, Tripura',
                salary: j.job_min_salary ? `‚Çπ${Math.round(j.job_min_salary).toLocaleString('en-IN')} ‚Äì ‚Çπ${Math.round(j.job_max_salary || j.job_min_salary * 1.5).toLocaleString('en-IN')}` : 'As per industry',
                category: detectCategoryFromText(j.job_title, j.employer_name),
                description: (j.job_description || 'Apply now.').substring(0, 250),
                requirements: [],
                posted: formatDate(j.job_posted_at_datetime_utc),
                deadline: 'Apply Soon',
                url: j.job_apply_link || '#',
                match: calcMatchLocal(j.job_title),
                isNew: isRecent(j.job_posted_at_datetime_utc),
                source: 'RapidAPI'
            }));
            jobs = jobs.concat(mapped);
            setProgress(20 + ((i + 1) / queries.length) * 70);
        } catch (e) { /* skip */ }
    }
    setProgress(100);
    return jobs;
}

function mergeApiJobs(apiJobs) {
    const seen = new Set(localJobs.map(j => normalize(j.title + j.company)));
    const unique = apiJobs.filter(j => {
        const key = normalize(j.title + j.company);
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
    });
    allJobs = [...localJobs, ...unique];
    sortJobs();
    filterCategory(currentCategory);
    updateStats();
    updateLastUpdate();
}

function normalize(str) { return str.toLowerCase().replace(/\s+/g, ''); }

// ============ CACHE ============
function saveToCache(jobs) {
    localStorage.setItem(CACHE_KEY, JSON.stringify({ ts: Date.now(), jobs }));
}
function loadFromCache() {
    try {
        const raw = localStorage.getItem(CACHE_KEY);
        if (!raw) return null;
        const { ts, jobs } = JSON.parse(raw);
        if (Date.now() - ts > CACHE_DURATION_MS) { localStorage.removeItem(CACHE_KEY); return null; }
        return jobs;
    } catch { return null; }
}
function clearCache() {
    localStorage.removeItem(CACHE_KEY);
    showToast('üóëÔ∏è Cache cleared');
}

// ============ HELPERS ============
function detectCategoryFromText(title, company) {
    const t = (title || '').toLowerCase(), c = (company || '').toLowerCase();
    if (c.includes('bank') || t.includes('bank')) return 'bank';
    if (t.includes('government') || c.includes('govt') || c.includes('department') || c.includes('ministry')) return 'government';
    if (t.includes('developer') || t.includes('software') || t.includes('data analyst') || t.includes('IT')) return 'it';
    if (t.includes('fresher') || t.includes('trainee') || t.includes('intern')) return 'fresher';
    return 'private';
}
function calcMatchLocal(title) {
    let s = 55;
    const t = (title || '').toLowerCase();
    if (t.includes('back office') || t.includes('clerk') || t.includes('assistant') || t.includes('data entry') || t.includes('computer')) s += 20;
    const sk = (userProfile.skills || '').toLowerCase();
    if (sk && sk.split(',').some(x => x.trim() && t.includes(x.trim()))) s += 10;
    return Math.min(s, 98);
}
function isRecent(dateStr) {
    if (!dateStr) return false;
    return (Date.now() - new Date(dateStr).getTime()) / 86400000 <= 3;
}
function formatDate(dateStr) {
    if (!dateStr) return 'Recently';
    const d = Math.floor((Date.now() - new Date(dateStr).getTime()) / 86400000);
    if (d <= 0) return 'Today';
    if (d === 1) return 'Yesterday';
    if (d < 7) return `${d} days ago`;
    if (d < 30) return `${Math.floor(d / 7)} weeks ago`;
    return `${Math.floor(d / 30)} months ago`;
}
function setApiBadge(type) {
    const el = document.getElementById('apiSourceLabel');
    if (type === 'live') { el.className = 'api-badge api-live'; el.textContent = 'üåê Live API'; }
    else if (type === 'cached') { el.className = 'api-badge api-cached'; el.textContent = '‚ö° Cached'; }
    else { el.className = 'api-badge api-local'; el.textContent = 'üì¶ Local'; }
}
function setProgress(pct) {
    const el = document.getElementById('progressFill');
    if (el) el.style.width = pct + '%';
}
function sortJobs() {
    allJobs.sort((a, b) => {
        if (a.isNew && !b.isNew) return -1;
        if (!a.isNew && b.isNew) return 1;
        return b.match - a.match;
    });
}

// ============ AUTO-UPDATE ============
function setupAutoUpdate() {
    if (settings.autoUpdate) startAutoUpdate();
    updateAutoUpdateUI();
}
function startAutoUpdate() {
    stopAutoUpdate();
    const ms = (settings.interval || 5) * 60 * 1000;
    nextUpdateSeconds = (settings.interval || 5) * 60;
    autoUpdateTimer = setInterval(() => {
        previousJobCount = allJobs.length;
        fetchLiveJobsIfPossible(true);
    }, ms);
    countdownTimer = setInterval(() => {
        if (--nextUpdateSeconds <= 0) nextUpdateSeconds = (settings.interval || 5) * 60;
        updateCountdown();
    }, 1000);
    updateCountdown();
}
function stopAutoUpdate() {
    if (autoUpdateTimer) { clearInterval(autoUpdateTimer); autoUpdateTimer = null; }
    if (countdownTimer) { clearInterval(countdownTimer); countdownTimer = null; }
}
function toggleAutoUpdate() {
    settings.autoUpdate = !settings.autoUpdate;
    localStorage.setItem('jobbot_settings', JSON.stringify(settings));
    settings.autoUpdate ? (startAutoUpdate(), showToast('‚ñ∂ Auto-update ON')) : (stopAutoUpdate(), showToast('‚è∏ Auto-update paused'));
    updateAutoUpdateUI();
}
function toggleAutoUpdateSetting() { toggleAutoUpdate(); }
function updateAutoUpdateUI() {
    const on = settings.autoUpdate;
    document.getElementById('autoUpdateStatus').innerHTML = on
        ? '<span class="w-2 h-2 bg-emerald-400 rounded-full live-dot"></span> Auto-update: ON'
        : '<span class="w-2 h-2 bg-slate-400 rounded-full inline-block"></span> Auto-update: OFF';
    document.getElementById('toggleAutoBtn').textContent = on ? 'Pause' : 'Resume';
    const sw = document.getElementById('autoUpdateToggle');
    const th = document.getElementById('autoUpdateThumb');
    sw.classList.toggle('bg-emerald-500', on); sw.classList.toggle('bg-slate-600', !on);
    if (th) { th.style.right = on ? '4px' : ''; th.style.left = on ? '' : '4px'; }
}
function updateCountdown() {
    const m = Math.floor(nextUpdateSeconds / 60), s = nextUpdateSeconds % 60;
    document.getElementById('nextUpdateTime').textContent = `Next: ${m}:${s.toString().padStart(2,'0')}`;
}
function saveUpdateInterval() {
    settings.interval = parseInt(document.getElementById('updateInterval').value);
    localStorage.setItem('jobbot_settings', JSON.stringify(settings));
    if (settings.autoUpdate) startAutoUpdate();
    showToast('Interval saved');
}
function toggleCaching() {
    settings.caching = !settings.caching;
    localStorage.setItem('jobbot_settings', JSON.stringify(settings));
    const sw = document.getElementById('cachingToggle');
    const th = document.getElementById('cachingThumb');
    sw.classList.toggle('bg-emerald-500', settings.caching); sw.classList.toggle('bg-slate-600', !settings.caching);
    if (th) { th.style.right = settings.caching ? '4px' : ''; th.style.left = settings.caching ? '' : '4px'; }
    showToast(settings.caching ? '‚úÖ Caching ON' : '‚ùå Caching OFF');
}

// ============ REFRESH ============
async function refreshJobs(forceApi = false) {
    const icon = document.getElementById('refreshIcon');
    icon.classList.add('refresh-spin');
    if (forceApi) localStorage.removeItem(CACHE_KEY);
    showLoading(true);
    await fetchLiveJobsIfPossible(false);
    showLoading(false);
    icon.classList.remove('refresh-spin');
    showToast('üîÑ Refreshed!');
}

// ============ NOTIFICATIONS ============
function checkNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
        document.getElementById('notificationBanner').classList.remove('hidden');
    }
    updateNotificationButton();
}
function updateNotificationButton() {
    const btn = document.getElementById('notifToggle');
    if (!btn) return;
    const granted = 'Notification' in window && Notification.permission === 'granted';
    btn.textContent = granted ? '‚úì Enabled' : 'Enable';
    btn.classList.toggle('bg-emerald-500/20', granted);
}
async function enableNotifications() {
    if ('Notification' in window) {
        const p = await Notification.requestPermission();
        if (p === 'granted') { showToast('üîî Notifications enabled!'); new Notification('JobBot Pro', { body: 'Job alerts are ON!' }); }
        else showToast('Notifications blocked by browser');
        updateNotificationButton();
    }
    dismissNotificationBanner();
}
function dismissNotificationBanner() { document.getElementById('notificationBanner').classList.add('hidden'); }
function sendNewJobsNotification(count) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('üéâ New Jobs!', { body: `${count} new jobs in Agartala found!`, tag: 'jobbot-new' });
    }
}

// ============ SEARCH ============
function liveSearch() {
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    let base = getFilteredByCategory(currentCategory);
    filteredJobs = q ? base.filter(j =>
        j.title.toLowerCase().includes(q) || j.company.toLowerCase().includes(q) ||
        j.location.toLowerCase().includes(q) || j.description.toLowerCase().includes(q) ||
        (j.requirements || []).some(r => r.toLowerCase().includes(q))
    ) : base;
    currentPage = 1;
    renderJobs(filteredJobs.slice(0, currentPage * JOBS_PER_PAGE));
    updateLoadMore();
    document.getElementById('jobCounter').textContent = filteredJobs.length + ' Jobs';
}
function clearSearch() {
    document.getElementById('searchInput').value = '';
    filterCategory(currentCategory);
}

// ============ FILTER ============
function getFilteredByCategory(cat) {
    if (cat === 'saved') return allJobs.filter(j => savedJobs.includes(j.id));
    if (cat !== 'all') return allJobs.filter(j => j.category === cat);
    return allJobs;
}
function filterCategory(cat, btn) {
    currentCategory = cat;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    else { const t = document.getElementById('tab-' + cat); if (t) t.classList.add('active'); }
    filteredJobs = getFilteredByCategory(cat);
    currentPage = 1;
    renderJobs(filteredJobs.slice(0, JOBS_PER_PAGE));
    updateLoadMore();
    hideNewJobToast();
}
function loadMoreJobs() {
    currentPage++;
    renderJobs(filteredJobs.slice(0, currentPage * JOBS_PER_PAGE));
    updateLoadMore();
}
function updateLoadMore() {
    document.getElementById('loadMoreBtn').classList.toggle('hidden', filteredJobs.length <= currentPage * JOBS_PER_PAGE);
}

// ============ RENDER ============
function renderJobs(jobs) {
    const container = document.getElementById('jobsList');
    const emptyState = document.getElementById('emptyState');
    if (jobs.length === 0) {
        emptyState.classList.remove('hidden');
        container.innerHTML = '';
        container.classList.add('hidden');
        document.getElementById('jobCounter').textContent = '0 Jobs';
        return;
    }
    emptyState.classList.add('hidden');
    container.classList.remove('hidden');
    document.getElementById('jobCounter').textContent = filteredJobs.length + ' Jobs';

    const icons = { government:'üèõÔ∏è', bank:'üè¶', private:'üè¢', fresher:'üéì', it:'üíª' };
    const colors = { government:'from-blue-500/20 to-blue-600/20', bank:'from-green-500/20 to-green-600/20', private:'from-purple-500/20 to-purple-600/20', fresher:'from-yellow-500/20 to-yellow-600/20', it:'from-cyan-500/20 to-cyan-600/20' };

    container.innerHTML = jobs.map((j, i) => `
        <div class="glass rounded-xl p-4 job-card cursor-pointer fade-in ${j.isNew ? 'new-job' : ''}"
            onclick="openJobModal(${JSON.stringify(j.id)})"
            style="animation-delay:${Math.min(i*0.04,0.4)}s">
            <div class="flex items-start gap-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br ${colors[j.category]||'from-slate-600 to-slate-700'} flex items-center justify-center text-2xl flex-shrink-0">
                    ${icons[j.category]||'üìã'}
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-2">
                        <div class="flex flex-wrap items-center gap-2">
                            <h3 class="font-semibold text-sm leading-snug">${escHtml(j.title)}</h3>
                            ${j.isNew?'<span class="text-xs bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded-full">NEW</span>':''}
                            ${j.source?`<span class="text-xs bg-cyan-500/10 text-cyan-400 px-2 py-0.5 rounded-full">${j.source}</span>`:''}
                        </div>
                        <button onclick="event.stopPropagation();toggleSave(${JSON.stringify(j.id)})" class="text-lg flex-shrink-0 hover:scale-125 transition-transform">${savedJobs.includes(j.id)?'‚≠ê':'‚òÜ'}</button>
                    </div>
                    <p class="text-xs text-slate-400 mb-2">${escHtml(j.company)}</p>
                    <div class="flex flex-wrap gap-3 text-xs text-slate-500">
                        <span>üìç ${escHtml(j.location)}</span>
                        <span>üí∞ ${escHtml(j.salary)}</span>
                    </div>
                    <div class="flex items-center justify-between mt-3">
                        <div class="flex items-center gap-2">
                            <div class="w-14 h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full ${j.match>=85?'bg-emerald-500':j.match>=70?'bg-yellow-500':'bg-slate-500'}" style="width:${j.match}%"></div>
                            </div>
                            <span class="text-xs font-medium ${j.match>=85?'text-emerald-400':j.match>=70?'text-yellow-400':'text-slate-400'}">${j.match}%</span>
                        </div>
                        <span class="text-xs text-slate-500">${j.posted}</span>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

// ============ JOB MODAL ============
function openJobModal(id) {
    const j = allJobs.find(x => x.id === id);
    if (!j) return;
    const icons = { government:'üèõÔ∏è', bank:'üè¶', private:'üè¢', fresher:'üéì', it:'üíª' };
    document.getElementById('jobModalContent').innerHTML = `
        <div class="flex items-center justify-between mb-6">
            <button onclick="closeJobModal()" class="p-2 glass rounded-lg hover:bg-white/10 text-sm">‚Üê Back</button>
            <div class="flex gap-2">
                <button onclick="shareJob(${JSON.stringify(j.id)})" class="p-2 glass rounded-lg hover:bg-white/10">üì§</button>
                <button onclick="toggleSave(${JSON.stringify(j.id)})" id="modalSaveBtn" class="p-2 glass rounded-lg text-xl hover:bg-white/10">${savedJobs.includes(j.id)?'‚≠ê':'‚òÜ'}</button>
            </div>
        </div>
        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-3xl mb-4">${icons[j.category]||'üìã'}</div>
        <h2 class="text-xl font-bold mb-1">${escHtml(j.title)}</h2>
        <p class="text-slate-400 mb-1">${escHtml(j.company)}</p>
        ${j.source?`<span class="text-xs bg-cyan-500/10 text-cyan-400 px-2 py-1 rounded-full">Source: ${j.source}</span>`:''}
        ${j.isNew?'<span class="inline-block text-xs bg-emerald-500/20 text-emerald-400 px-2 py-1 rounded-full ml-1">üÜï NEW</span>':''}
        <div class="flex items-center gap-2 my-4">
            <div class="w-20 h-2 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-full ${j.match>=85?'bg-emerald-500':j.match>=70?'bg-yellow-500':'bg-slate-500'}" style="width:${j.match}%"></div>
            </div>
            <span class="text-sm font-medium ${j.match>=85?'text-emerald-400':j.match>=70?'text-yellow-400':'text-slate-400'}">${j.match}% Match</span>
        </div>
        <div class="grid grid-cols-2 gap-3 mb-4">
            <div class="glass rounded-xl p-3"><p class="text-xs text-slate-400">Location</p><p class="text-sm font-medium">${escHtml(j.location)}</p></div>
            <div class="glass rounded-xl p-3"><p class="text-xs text-slate-400">Salary</p><p class="text-sm font-medium">${escHtml(j.salary)}</p></div>
            <div class="glass rounded-xl p-3"><p class="text-xs text-slate-400">Posted</p><p class="text-sm font-medium">${escHtml(j.posted)}</p></div>
            <div class="glass rounded-xl p-3"><p class="text-xs text-slate-400">Deadline</p><p class="text-sm text-yellow-400 font-medium">${escHtml(j.deadline)}</p></div>
        </div>
        <div class="mb-4">
            <h3 class="text-sm font-semibold mb-2">Description</h3>
            <p class="text-sm text-slate-300 leading-relaxed">${escHtml(j.description)}</p>
        </div>
        ${j.requirements?.length?`<div class="mb-6"><h3 class="text-sm font-semibold mb-2">Requirements</h3><div class="flex flex-wrap gap-2">${j.requirements.map(r=>`<span class="text-xs bg-white/5 border border-white/10 px-3 py-1 rounded-full">${escHtml(r)}</span>`).join('')}</div></div>`:''}
        <div class="space-y-3">
            ${appliedJobs.includes(j.id)
                ?'<div class="bg-emerald-500/20 border border-emerald-500/30 text-emerald-400 text-center py-3 rounded-xl font-medium">‚úÖ Already Applied</div>'
                :`<button onclick="applyToJob(${JSON.stringify(j.id)})" class="w-full btn-primary text-white py-3 rounded-xl font-semibold">üìß Apply via Email</button>`}
            <button onclick="sendToTelegram(${JSON.stringify(j.id)})" class="w-full btn-telegram text-white py-3 rounded-xl font-medium">üì® Send to Telegram</button>
            ${j.url&&j.url!=='#'?`<a href="${j.url}" target="_blank" rel="noopener" class="block w-full text-center glass py-3 rounded-xl hover:bg-white/10 transition-all">üîó Open Job Posting</a>`:''}
        </div>
    `;
    document.getElementById('jobModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
}
function closeJobModal() { document.getElementById('jobModal').classList.add('hidden'); document.body.style.overflow = ''; }

// ============ ACTIONS ============
function toggleSave(id) {
    if (savedJobs.includes(id)) { savedJobs = savedJobs.filter(x => x !== id); showToast('Removed from saved'); }
    else { savedJobs.push(id); showToast('‚≠ê Saved!'); }
    localStorage.setItem('jobbot_saved', JSON.stringify(savedJobs));
    filterCategory(currentCategory); updateStats();
    const btn = document.getElementById('modalSaveBtn');
    if (btn) btn.textContent = savedJobs.includes(id) ? '‚≠ê' : '‚òÜ';
}
function applyToJob(id) {
    const j = allJobs.find(x => x.id === id);
    if (!j) return;
    if (!appliedJobs.includes(id)) { appliedJobs.push(id); localStorage.setItem('jobbot_applied', JSON.stringify(appliedJobs)); updateStats(); }
    const sub = encodeURIComponent(`Application for ${j.title}`);
    const body = encodeURIComponent(`Dear Hiring Manager,\n\nI am applying for ${j.title} at ${j.company}.\n\nName: ${userProfile.name||''}\nEmail: ${userProfile.email||''}\nPhone: ${userProfile.phone||''}\nSkills: ${userProfile.skills||''}\nLocation: Agartala, Tripura\n\nThank you.\n\n${userProfile.name||'Candidate'}`);
    window.open(`mailto:?subject=${sub}&body=${body}`);
    showToast('Opening email client...');
    openJobModal(id);
}
function shareJob(id) {
    const j = allJobs.find(x => x.id === id);
    if (!j) return;
    const text = `üåü ${j.title}\nüìç ${j.company}, ${j.location}\nüí∞ ${j.salary}\n\n${j.url !== '#' ? j.url : 'JobBot Pro'}`;
    if (navigator.share) navigator.share({ title: j.title, text });
    else navigator.clipboard.writeText(text).then(() => showToast('Copied!'));
}
async function sendToTelegram(id) {
    const j = allJobs.find(x => x.id === id);
    if (!j) return;
    const { telegramToken: token, telegramChatId: chatId } = userProfile;
    if (!token || !chatId) { showToast('Setup Telegram in Settings'); closeJobModal(); openSettings(); return; }
    try {
        const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, parse_mode: 'Markdown',
                text: `üåü *${j.title}*\nüìç ${j.company}, ${j.location}\nüí∞ ${j.salary}\nüìä Match: ${j.match}%\n${j.url!=='#'?'\nüîó '+j.url:''}` })
        });
        const data = await res.json();
        showToast(data.ok ? '‚úÖ Sent to Telegram!' : 'Error: ' + data.description);
    } catch { showToast('Failed to send'); }
}

// ============ SETTINGS ============
function openSettings() { document.getElementById('settingsModal').classList.remove('hidden'); document.body.style.overflow = 'hidden'; }
function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); document.body.style.overflow = ''; }
function loadSettingsToForm() {
    const f = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
    f('settingsName', userProfile.name); f('settingsEmail', userProfile.email);
    f('settingsPhone', userProfile.phone); f('settingsSkills', userProfile.skills);
    f('settingsTelegramToken', userProfile.telegramToken); f('settingsTelegramChatId', userProfile.telegramChatId);
    f('adzunaAppId', userProfile.adzunaAppId); f('adzunaAppKey', userProfile.adzunaAppKey);
    f('rapidApiKey', userProfile.rapidApiKey);
}
function loadSavedSettings() {
    const sel = document.getElementById('updateInterval');
    if (sel) sel.value = settings.interval || 5;
    // Caching toggle
    const sw = document.getElementById('cachingToggle'), th = document.getElementById('cachingThumb');
    if (sw) { sw.classList.toggle('bg-emerald-500', settings.caching !== false); sw.classList.toggle('bg-slate-600', settings.caching === false); }
    if (th) { th.style.right = settings.caching !== false ? '4px' : ''; th.style.left = settings.caching !== false ? '' : '4px'; }
}
function saveSettings() {
    userProfile = {
        name: document.getElementById('settingsName').value.trim(),
        email: document.getElementById('settingsEmail').value.trim(),
        phone: document.getElementById('settingsPhone').value.trim(),
        skills: document.getElementById('settingsSkills').value.trim(),
        telegramToken: document.getElementById('settingsTelegramToken').value.trim(),
        telegramChatId: document.getElementById('settingsTelegramChatId').value.trim(),
        adzunaAppId: document.getElementById('adzunaAppId').value.trim(),
        adzunaAppKey: document.getElementById('adzunaAppKey').value.trim(),
        rapidApiKey: document.getElementById('rapidApiKey').value.trim(),
    };
    localStorage.setItem('jobbot_profile', JSON.stringify(userProfile));
    showToast('‚úÖ Settings saved!'); closeSettings();
    // Try live fetch if keys were added
    if (userProfile.adzunaAppId || userProfile.rapidApiKey) {
        document.getElementById('apiLimitBanner').classList.add('hidden');
        fetchLiveJobsIfPossible(false);
    }
}
async function testAdzuna() {
    const appId = document.getElementById('adzunaAppId').value.trim() || ADZUNA_APP_ID;
    const appKey = document.getElementById('adzunaAppKey').value.trim() || ADZUNA_APP_KEY;
    if (!appId || !appKey) { showToast('Enter App ID and App Key first'); return; }
    showToast('Testing Adzuna connection...');
    try {
        const url = `https://api.adzuna.com/v1/api/jobs/in/search/1?app_id=${appId}&app_key=${appKey}&results_per_page=1&what=jobs&where=Agartala&content-type=application/json`;
        const data = await fetchWithCorsProxy(url);
        if (data && data.results !== undefined) {
            showToast(`‚úÖ Adzuna works! (${data.count || '?'} jobs found)`);
        } else {
            showToast('‚ùå Adzuna error ‚Äî check your keys');
        }
    } catch { showToast('‚ùå Adzuna connection failed'); }
}
async function testTelegram() {
    const token = document.getElementById('settingsTelegramToken').value.trim();
    const chatId = document.getElementById('settingsTelegramChatId').value.trim();
    if (!token || !chatId) { showToast('Enter Token & Chat ID'); return; }
    try {
        const res = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ chat_id: chatId, text: '‚úÖ *JobBot Pro connected!*\n\nJob alerts from Agartala will appear here!', parse_mode: 'Markdown' })
        });
        const data = await res.json();
        showToast(data.ok ? '‚úÖ Telegram connected!' : 'Error: ' + data.description);
    } catch { showToast('‚ùå Telegram failed'); }
}

// ============ UTILITY ============
function showLoading(show) {
    document.getElementById('loadingState').classList.toggle('hidden', !show);
    document.getElementById('jobsList').classList.toggle('hidden', show);
    if (show) document.getElementById('emptyState').classList.add('hidden');
}
function updateStats() {
    document.getElementById('statTotal').textContent = allJobs.length;
    document.getElementById('statNew').textContent = allJobs.filter(j => j.isNew).length;
    document.getElementById('statSaved').textContent = savedJobs.length;
    document.getElementById('statMatch').textContent = allJobs.filter(j => j.match >= 85).length;
    document.getElementById('statApplied').textContent = appliedJobs.length;
}
function updateLastUpdate() {
    const el = document.getElementById('lastUpdate');
    if (el) el.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
}
function showToast(msg) {
    if (toastTimeout) clearTimeout(toastTimeout);
    document.getElementById('toastMessage').textContent = msg;
    document.getElementById('toast').classList.remove('hidden');
    toastTimeout = setTimeout(() => { document.getElementById('toast').classList.add('hidden'); toastTimeout = null; }, 3000);
}
function showNewJobsAlert(count) {
    const badge = document.getElementById('newJobsBadge');
    badge.textContent = `+${count} new`; badge.classList.remove('hidden');
    document.getElementById('newJobToastCount').textContent = `${count} new jobs available`;
    document.getElementById('newJobToast').classList.remove('hidden');
    setTimeout(() => document.getElementById('newJobToast').classList.add('hidden'), 5000);
}
function hideNewJobToast() {
    document.getElementById('newJobToast').classList.add('hidden');
    document.getElementById('newJobsBadge').classList.add('hidden');
}
function escHtml(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeJobModal(); closeSettings(); } });
</script>
</body>
</html>
